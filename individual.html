<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å€‹äººãƒ“ãƒ¥ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.0/src/wordcloud2.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
      max-width: 700px;
      margin: 0 auto;
    }
    h2 {
      color: #333;
      text-align: center;
    }
    .record {
      background: #fff;
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .record time {
      font-size: 0.9em;
      color: #666;
    }
    .record p {
      margin: 4px 0;
    }
    .warning {
      color: red;
      font-weight: bold;
      text-align: center;
    }
    canvas {
      background: #fff;
      border-radius: 8px;
      margin-top: 20px;
    }
    .summary-controls {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>ã“ã“ã‚ã®è¨˜éŒ²ï¼ˆå€‹äººãƒ“ãƒ¥ãƒ¼ï¼‰</h2>
  <div class="summary-controls">
    <p id="studentNameLabel">èª­ã¿è¾¼ã¿ä¸­...</p>
    <label for="periodSelect">æœŸé–“ï¼š</label>
    <select id="periodSelect">
      <option value="day">ä»Šæ—¥</option>
      <option value="week">ä»Šé€±</option>
      <option value="month" selected>ä»Šæœˆ</option>
    </select>
    <button onclick="loadSummaryGraph()">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</button>
  </div>
  <canvas id="summaryChart" width="600" height="300"></canvas>
  <canvas id="zoneChart" width="600" height="300"></canvas>
  <div style="width: 100%; height: 300px; margin-top: 20px;">
    <canvas id="wordCanvas" width="600" height="300"></canvas>
  </div>
  <div id="recordContainer"></div>

  <script>
    let studentList = [];
    let currentStudentName = "";

    google.script.run.withSuccessHandler(function(userEmail) {
      google.script.run.withSuccessHandler(function(data) {
        studentList = data;
        const match = studentList.find(s => s.email === userEmail);
        const label = document.getElementById("studentNameLabel");

        if (match) {
          currentStudentName = match.name;
          label.textContent = `ã‚ˆã†ã“ãã€${match.name} ã•ã‚“`;
          google.script.run.withSuccessHandler(renderRecords).getResponsesByName(match.name);
          loadSummaryGraph();
        } else {
          label.textContent = "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯è¨˜éŒ²ã®é–²è¦§æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        }
      }).getStudentList();
    }).getMyEmail();

    function renderRecords(data) {
      const container = document.getElementById("recordContainer");
      container.innerHTML = "";
      if (!data || data.length === 0) {
        container.innerHTML = "<p class='warning'>è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
        return;
      }
      for (const record of data) {
        const div = document.createElement("div");
        div.className = "record";
        div.innerHTML = `
          <time>${record["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"]}ï¼ˆ${record["ãƒ¢ãƒ¼ãƒ‰"]}ï¼‰</time>
          <p><strong>ã‚¾ãƒ¼ãƒ³ï¼š</strong> ${record["å¿ƒã®ã‚¾ãƒ¼ãƒ³ã¯ï¼Ÿ"] || "-"}</p>
          <p><strong>æ„Ÿæƒ…ï¼š</strong> ${record["ä»Šã®æ„Ÿæƒ…ã¯ï¼Ÿ"] || "-"}</p>
          <p><strong>ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š</strong> ${record["å¿ƒã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯ï¼Ÿ"] || "-"}</p>
          <p><strong>ä»Šæ—¥ã®ã‚³ã‚³ãƒ­ã‚°ï¼š</strong> ${record["ãã‚‡ã†ã®ã‚³ã‚³ãƒ­ã‚°"] || record["ãã®ãŸã‚ã«ä½•ã™ã‚‹ï¼Ÿ"] || "-"}</p>
          <p><strong>AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š</strong> ${record["AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"] || "-"}</p>
          <p><strong>å…ˆç”Ÿã‚³ãƒ¡ãƒ³ãƒˆï¼š</strong> ${record["å…ˆç”Ÿã‚³ãƒ¡ãƒ³ãƒˆ"] || "-"}</p>
        `;
        container.appendChild(div);
      }
    }

    function loadSummaryGraph() {
      const period = document.getElementById("periodSelect").value;
      if (!currentStudentName) return;
      console.log("ğŸ“Š loadSummaryGraph â†’", currentStudentName, period);
      google.script.run.withSuccessHandler(drawAllGraphs).getPersonalStatsByPeriod(currentStudentName, period);
    }

    function drawAllGraphs(data) {
      console.log("drawAllGraphs received:", data);
      drawEnergyLineChart(data);
      drawZoneBarChart(data);
      drawCocologWordCloud(data);
    }

    function drawEnergyLineChart(data) {
      console.log("drawEnergyLineChart received data:", data);
      const ctx = document.getElementById("summaryChart").getContext("2d");
      const labels = data.map(d => d.æ—¥ä»˜);
      const energies = data.map(d => Number(d["å¿ƒã®ã‚¨ãƒãƒ«ã‚®ãƒ¼"]) || null);

      if (window.summaryChartInstance) {
        window.summaryChartInstance.destroy();
      }

      window.summaryChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å¿ƒã®ã‚¨ãƒãƒ«ã‚®ãƒ¼',
            data: energies,
            fill: false,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: true, text: 'ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ¨ç§»' }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function drawZoneBarChart(data) {
      const ctx = document.getElementById("zoneChart").getContext("2d");
      const counts = { "ğŸ˜€": 0, "ğŸ˜Œ": 0, "ğŸ˜": 0, "ğŸ˜¡": 0 };
      data.forEach(d => {
        if (d["å¿ƒã®ã‚¾ãƒ¼ãƒ³ã¯ï¼Ÿ"] && counts.hasOwnProperty(d["å¿ƒã®ã‚¾ãƒ¼ãƒ³ã¯ï¼Ÿ"])) {
          counts[d["å¿ƒã®ã‚¾ãƒ¼ãƒ³ã¯ï¼Ÿ"]]++;
        }
      });

      if (window.zoneChartInstance) window.zoneChartInstance.destroy();
      window.zoneChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            label: 'ã‚¾ãƒ¼ãƒ³åˆ¥å›æ•°',
            data: Object.values(counts),
            backgroundColor: ['#fdd835', '#81c784', '#64b5f6', '#e57373']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'å¿ƒã®ã‚¾ãƒ¼ãƒ³ã®å›æ•°' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function drawCocologWordCloud(data) {
      const wordMap = {};
      data.forEach(d => {
        const text = `${d.ã‚³ã‚³ãƒ­ã‚° || ''} ${d["ãã®ãŸã‚ã«ä½•ã™ã‚‹ï¼Ÿ"] || ''}`;
        const words = text.split(/\s+|ã€|ã€‚|\n|\r|ã€€|,|ãƒ»|\.|!|ï¼|\?|ï¼Ÿ/);
        words.forEach(word => {
          const w = word.trim();
          if (w.length > 1) {
            wordMap[w] = (wordMap[w] || 0) + 1;
          }
        });
      });
      const wordArray = Object.entries(wordMap).map(([word, count]) => [word, count]);
      if (wordArray.length === 0) {
        wordArray.push(["è¨˜éŒ²ãªã—", 1]);
      }
      WordCloud(document.getElementById("wordCanvas"), {
        list: wordArray,
        gridSize: 12,
        weightFactor: 10,
        backgroundColor: "#fff"
      });
    }
  </script>
</body>
</html>