<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†è€…ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆç”Ÿã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ä»˜ãï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f2f2f2;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .record, .summary {
      background: #fff;
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .record time {
      font-size: 0.9em;
      color: #666;
    }
    .record p {
      margin: 4px 0;
    }
    .warning {
      color: red;
      font-weight: bold;
      text-align: center;
    }
    .admin-controls {
      margin-top: 24px;
    }
    textarea {
      width: 100%;
      min-height: 60px;
      font-size: 0.9em;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 6px;
    }
    button.comment-button {
      background-color: #2d89ef;
      color: white;
      border: none;
      padding: 6px 12px;
      margin-top: 6px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
  <div id="accessGate">
    <p class="warning">èªè¨¼ä¸­...</p>
  </div>
  <div id="adminContainer" style="display:none;">
    <div class="admin-controls">
      <label for="studentSelect">ç”Ÿå¾’ã‚’é¸æŠï¼š</label>
      <select id="studentSelect"></select>
      <button onclick="loadStudentRecords()">è¡¨ç¤º</button>
    </div>
    <div class="summary">
      <h3>ä»Šæ—¥ã®æå‡ºã‚µãƒãƒªãƒ¼</h3>
      <canvas id="zoneChart" width="400" height="200"></canvas>
    </div>
    <div class="summary">
      <h3>ç”Ÿå¾’ã”ã¨ã®ç›´è¿‘ã®æŠ•ç¨¿</h3>
      <div id="latestContainer"></div>
    </div>
    <div id="recordContainer"></div>
  </div>

  <script>
    let students = [];

    google.script.run.withSuccessHandler(function(email) {
      google.script.run.withSuccessHandler(function(admins) {
        const me = admins.find(a => a.email === email);
        if (me) {
          document.getElementById("accessGate").style.display = "none";
          document.getElementById("adminContainer").style.display = "block";
          initStudentList();
          loadDailySummary();
          loadLatestPosts();
        } else {
          document.getElementById("accessGate").innerHTML = "<p class='warning'>ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
        }
      }).getAdminList();
    }).getMyEmail();

    function initStudentList() {
      google.script.run.withSuccessHandler(function(data) {
        students = data;
        const select = document.getElementById("studentSelect");
        data.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.name.trim();
          opt.textContent = s.name;
          select.appendChild(opt);
        });
      }).getStudentList();
    }

    function loadStudentRecords() {
      const name = document.getElementById("studentSelect").value.trim();
      if (!name) return;
      google.script.run.withSuccessHandler(renderRecords).getResponsesByName(name);
    }

    function renderRecords(data) {
      const container = document.getElementById("recordContainer");
      container.innerHTML = "";
      if (!data || data.length === 0) {
        container.innerHTML = "<p class='warning'>è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
        return;
      }
      data.forEach(record => {
        const div = document.createElement("div");
        div.className = "record";
        const ts = record["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"];
        div.innerHTML = `
          <time>${ts}ï¼ˆ${record["ãƒ¢ãƒ¼ãƒ‰"]}ï¼‰</time>
          <p><strong>æ°åï¼š</strong> ${record["æ°å"] || "-"}</p>
          <p><strong>ã‚¾ãƒ¼ãƒ³ï¼š</strong> ${record["å¿ƒã®ã‚¾ãƒ¼ãƒ³ã¯ï¼Ÿ"] || "-"}</p>
          <p><strong>æ„Ÿæƒ…ï¼š</strong> ${record["ä»Šã®æ„Ÿæƒ…ã¯ï¼Ÿ"] || "-"}</p>
          <p><strong>ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š</strong> ${record["å¿ƒã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯ï¼Ÿ"] || "-"}</p>
          <p><strong>è¨˜éŒ²ï¼š</strong> ${record["ãã‚‡ã†ã®ã‚³ã‚³ãƒ­ã‚°"] || record["ãã®ãŸã‚ã«ä½•ã™ã‚‹ï¼Ÿ"] || "-"}</p>
          <label>å…ˆç”Ÿã‚³ãƒ¡ãƒ³ãƒˆï¼š</label>
          <textarea id="comment-${ts}">${record["å…ˆç”Ÿã‚³ãƒ¡ãƒ³ãƒˆ"] || ""}</textarea>
        `;
        const button = document.createElement("button");
        button.className = "comment-button";
        button.textContent = "ä¿å­˜";
        button.addEventListener("click", () => saveComment(ts));
        div.appendChild(button);
        container.appendChild(div);
      });
    }

    function saveComment(timestamp) {
      const textarea = document.getElementById("comment-" + timestamp);
      const comment = textarea.value;
      google.script.run.withSuccessHandler(() => {
        alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        loadStudentRecords();
      }).saveTeacherComment(timestamp, comment);
    }

    function loadDailySummary() {
      google.script.run.withSuccessHandler(function(summary) {
        const ctx = document.getElementById('zoneChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ğŸ˜€', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ˜¡'],
            datasets: [{
              label: 'äººæ•°',
              data: [summary["ğŸ˜€"] || 0, summary["ğŸ˜Œ"] || 0, summary["ğŸ˜"] || 0, summary["ğŸ˜¡"] || 0],
              backgroundColor: ['#fdd835', '#81c784', '#64b5f6', '#e57373']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'ä»Šæ—¥ã®ã‚¾ãƒ¼ãƒ³åˆ¥äººæ•°' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }).getTodayZoneSummary();
    }

    function loadLatestPosts() {
      google.script.run.withSuccessHandler(function(data) {
        const container = document.getElementById("latestContainer");
        container.innerHTML = "";
        if (!data || data.length === 0) {
          container.innerHTML = "<p class='warning'>ç›´è¿‘ã®æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
          return;
        }
        data.forEach(record => {
          const div = document.createElement("div");
          div.className = "record";
          div.innerHTML = `
            <time>${record["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"]}ï¼ˆ${record["ãƒ¢ãƒ¼ãƒ‰"]}ï¼‰</time>
            <p><strong>æ°åï¼š</strong> ${record["æ°å"] || "-"}</p>
            <p><strong>ã‚¾ãƒ¼ãƒ³ï¼š</strong> ${record["å¿ƒã®ã‚¾ãƒ¼ãƒ³ã¯ï¼Ÿ"] || "-"}</p>
            <p><strong>æ„Ÿæƒ…ï¼š</strong> ${record["ä»Šã®æ„Ÿæƒ…ã¯ï¼Ÿ"] || "-"}</p>
            <p><strong>ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š</strong> ${record["å¿ƒã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯ï¼Ÿ"] || "-"}</p>
            <p><strong>è¨˜éŒ²ï¼š</strong> ${record["ãã‚‡ã†ã®ã‚³ã‚³ãƒ­ã‚°"] || record["ãã®ãŸã‚ã«ä½•ã™ã‚‹ï¼Ÿ"] || "-"}</p>
          `;
          container.appendChild(div);
        });
      }).getLatestPostByStudents();
    }
  </script>
</body>
</html>
